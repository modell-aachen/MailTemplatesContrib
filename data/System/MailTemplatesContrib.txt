%META:TOPICPARENT{name="Contribs"}%
<!--
One line description, required for extensions repository catalog.
   * Set SHORTDESCRIPTION = %$SHORTDESCRIPTION%
-->
---+!! Empty Contrib

%SHORTDESCRIPTION%

%TOC%

---++ Usage
---+++ Send Mail from CLI
The tool from $WIKIDIR/tools/mailtemplate_send can be used to send mails from command line.
To execute the script you can call it with a given template and a given web.
E.g.:
<pre>
perl mailtemplate_send template=mailtemplatescontrib web=Processes
</pre>

The recipients and from address should be set in the template, in the ModacMail block.
<pre>
%<nop>TMPL:DEF{"ModacMailTo"}%UserName%<nop>TMPL:END%
%<nop>TMPL:DEF{"ModacMailFrom"}%qwiki@modell-aachen.de%<nop>TMPL:END%
</pre>

When you like to generate you recipents by Solr you can use a =ModacMailPrimer= block to get some Solr search result with a facet of users and define you users format in the =ModacMailTo= field.

There are some more parameters to call the mailtemplate_send function with:

   * =topic=: you can specify a topic as context.
   * =options_SingleMail=: if true: join all receipients to a single =To= %BR% otherwise: send a separate mail to each receipient
   * =options_beforeSend=: ref to callback function that will be called just before the email will be send out
   * =options_beforeSendArgs=: arrayref of arguments to the callback%BR%The text of the mail will be unshiftet to this array
   * =options_SkipUsers=: do not send mails to users whose WikiName is in this hashref; any user receiving a mail will be added automatically
   * =options_SkipMailUsers=: do not send mails to addresses in this hashref; any address receiving a mail will be added automatically
   * =options_IncludeMailUsers=: only send mails to users whose emails are in this hashref
   * =options_IncludeUsers=: only send mails to users whose WikiNames are in this hashref
   * =options_id=: entries in logfiles will show this id
   * =options_GenerateOnly=: only generate mails, do not actually send them
   * =options_GenerateInAdvance=: do not delay generating mails to the grinder (use this if you have stuff set in the session or need any of the results like =SkipMailUsers=)
   * =options_AllowMailsWithoutUser=: allow mail addresses that have no user associated with them (eg. roles like sales@...).

Example call for a cron job:
<pre>
0    7 * * 1-6 cd /var/www/qwiki/tools; perl mailtemplate_send template=ApprovedTopicByResponsibleMail web=Processes options_SkipUsers=WikiGuest,ProjectContributor
</pre>

and a example template which should inform the responsible of a topic that it is approved since today. This should only show how to use =ModacMailPrimer= and =ModacMailEachPrimer=, so you need to modify it your your needs:
<pre>
<verbatim>
%TMPL:INCLUDE{"mailtemplatescontrib"}%

%TMPL:DEF{"ModacMailPrimer"}%
%SOLRSEARCH{"web:%URLPARAM{"web"}% type:topic workflowmeta_lasttime_approved_dt:[NOW/DAY-1DAY TO NOW]"
rows="1" id="who" facets="field_Responsible_s" facetlimit="9999"}%
%TMPL:END%

%TMPL:DEF{"ModacMailEachPrimer"}%%SOLRSEARCH{"type:topic ((field_Responsible_s: %to_WikiName% workflow_lasttime_approved_dt:[NOW/DAY-1DAY TO NOW]))" id="eachkvp%ModacMailCount%" rows="1" fields="topic"}%%TMPL:END%

%TMPL:DEF{"ModacMailTo"}%%SOLRFORMAT{"who" format_field_Responsible_s="$key" separator_field_Responsible_s=","}%%TMPL:END%

%TMPL:DEF{"ModacMailSubject"}%%MAKETEXT{"[_1]: Your approved topics" args="%WIKITOOLNAME%"}%%TMPL:END%

%TMPL:DEF{"ModacMailContents"}%
%MAKETEXT{"Dear [_1]," args="%to_WikiName%"}%
%BR%%BR%
Your last approved Topics:
%SOLRFORMAT{"eachkvp%ModacMailCount%" format="[[$webtopic][$title]] - $workflowmeta_lasttime_approved_dt$n"}%
%BR%
%MAKETEXT{"Best Regards,<br/>Your [_1] Team" args="%WIKITOOLNAME%"}%
%TMPL:END%

%TMPL:DEF{"ModacMailFrom"}%%WIKIWEBMASTERNAME% <%WIKIWEBMASTER%>%TMPL:END%

%TMPL:DEF{"ModacMailType"}%text/html%TMPL:END%
</verbatim>
</pre>

---+++ Language settings

---++++ When sending from the CLI

When sending from the command line, there are several ways to influence the language of the mail.

Below they are listed in their priority, meaning the topmost method will override anything below.

| *method* | *example* |
| Set =LANGUAGE= on the command line. | =sudo -u www-data perl mailtemplate_send template=mailtemplatescontrib web=Processes %RED%LANGUAGE=de%ENDCOLOR%= |
| Set =BACKEND_MAIL_LANGUAGE= on your =SitePreferences= %BR% _Note:_ This will only apply when mails are send via the cli. | =&nbsp;&nbsp;&nbsp;&#42;&nbsp;Set BACKEND_MAIL_LANGUAGE = de= |
| Set =MAIL_LANGUAGE= on your =SitePreferences= %BR% _Note:_ This will apply to many mails, even some generated by the user. | =&nbsp;&nbsp;&nbsp;&#42;&nbsp;Set MAIL_LANGUAGE = de= |
| Set =LANGUAGE= on your =SitePreferences= (or =WebPreferences= if you set a web) %BR% _Note:_ This will also affect how the wiki is displayed in the browser. | =&nbsp;&nbsp;&nbsp;&#42;&nbsp;Set LANGUAGE = de= |

---++++ When generating mails from the frontend

When emails are generated from the frontend (eg. by =KVPPlugin=) the language is determined by the following rules:
   * If the plugin sets a language, that will be used
   * otherwise if =MAIL_LANGUAGE= is set on the =SitePreferences=, that will be used
   * otherwise the browser language will be used.

---++ Installation
%$INSTALL_INSTRUCTIONS%

---+++ Installation of system services for mailtemplatesgrinder.

For the integration with the TaskDaemonPlugin (also known as mattdaemon) to work, this extensions need a installed system service.
Service files for systemd are provided in =resources/MailTemplatesContrib= in your Foswiki root directory.
If you use this configuration, your daemon will run as a systemd instantiated service.

Preliminaries:
   * =$FOSWIKI_ROOT= Your Foswiki root directory
   * =$INSTANCE= The name of the Foswiki instance. Even if you run only one Foswiki instance, you need to decide for one, e.g. =qwiki=.
Installation instructions f√ºr Debian Linux.

<pre>
install -o root -g root $FOSWIKI_ROOT/resources/MailTemplatesContrib/systemd/config/mailtemplatesworker /etc/default/mailtemplatesworker-$INSTANCE
install -o root -g root $FOSWIKI_ROOT/resources/MailTemplatesContrib/systemd/mailtemplatesworker@.service /etc/systemd/system/mailtemplatesworker@.service
</pre>

   * Edit =/etc/default/mailtemplatesworker-$INSTANCE= and change the Foswiki root directory path.
   * Edit =/etc/systemd/system/mailtemplatesworker@.service= and change the User to your webserver user (the default works for Debian).

Activate the service:

<pre>
systemctl daemon-reload
systemctl enable  mailtemplatesworker@$INSTANCE
systemctl restart mailtemplatesworker@$INSTANCE
</pre>

Now, change the option ={Extension}{MailTemplatesContrib}{UseGrinder}= in =/bin/configure= to =true= to use the mailtemplatesgrinder.

---++ Info

|  Author: | StephanOsthold |
|  Copyright: | &copy; %$CREATEDYEAR%, StephanOsthold, All Rights Reserved |
|  License: | GPL ([[http://www.gnu.org/copyleft/gpl.html][GNU General Public License]]) |
|  Dependencies: | %$DEPENDENCIES% |
|  Version: | %$VERSION% |
|  Release: | %$RELEASE% |
|  Change History: | <!-- versions below in reverse order -->&nbsp; |
|  1.0.0 (XX Mmm 20XX): | Initial version |
|  Home: | http://foswiki.org/Extensions/%TOPIC% |
|  Support: | http://foswiki.org/Support/%TOPIC% |
